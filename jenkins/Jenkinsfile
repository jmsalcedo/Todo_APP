pipeline {
    agent {
        docker {
            image 'python:3.12-slim'
            args '-u root'
        }
    }

    environment {
        // Aseguramos que uv esté en el PATH para todos los stages
        PATH = "/root/.local/bin:${env.PATH}"
        DATABASE_URL = "postgresql://user:password@postgres:5432/todo_db"
    }

    stages {
        stage('Setup Environment') {
            steps {
                script {
                    echo 'Instalando herramientas necesarias en el contenedor...'
                    // Instalamos curl para bajar uv. Git no es necesario aquí 
                    // porque Jenkins ya clonó el código desde fuera del contenedor.
                    sh 'apt-get update && apt-get install -y curl docker.io'
                    sh 'curl -LsSf https://astral.sh/uv/install.sh | sh'
                    
                    // Verificamos instalación
                    sh '/root/.local/bin/uv --version'
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                echo 'Sincronizando dependencias con uv...'
                // uv sync busca el archivo pyproject.toml en la raíz
                sh '/root/.local/bin/uv sync'
            }
        }

        stage('Lint & Static Analysis') {
            steps {
                echo 'Ejecutando Linter (Ruff)...'
                // Usamos la ruta absoluta por seguridad
                sh '/root/.local/bin/uv run ruff check .'
            }
        }

        stage('Run Integration Tests') {
            steps {
                echo 'Ejecutando Pruebas (Pytest)...'
                script {
                    docker.image('postgres:15-alpine').withRun(
                        '-e POSTGRES_USER=user ' +
                        '-e POSTGRES_PASSWORD=password ' +
                        '-e POSTGRES_DB=todo_db ' +
                        '--name todo_db' // El host ahora será 'postgres'
                    ) { c ->
                        echo 'Esperando a que Postgres esté listo...'
                        // Damos unos segundos para que la DB inicie
                        sh 'sleep 10' 
                        
                        echo 'Ejecutando Pytest...'
                        // Pasamos la URL de la base de datos como variable de entorno
                        sh 'DATABASE_URL=$DATABASE_URL /root/.local/bin/uv run pytest'
                    }
                }
            }
        }
    }

    post {
        success {
            echo '¡Pipeline completado con éxito!'
        }
        failure {
            echo 'El pipeline falló. Revisa los pasos anteriores.'
        }
        always {
            echo 'Finalizando ejecución...'
        }
    }
}