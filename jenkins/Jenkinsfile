pipeline {
    agent {
        docker {
            image 'python:3.12-slim'
            args '-u root'
        }
    }

    environment {
        // Aseguramos que uv esté en el PATH para todos los stages
        PATH = "/root/.local/bin:${env.PATH}"
    }

    stages {
        stage('Setup Environment') {
            steps {
                script {
                    echo 'Instalando herramientas necesarias en el contenedor...'
                    // Instalamos curl para bajar uv. Git no es necesario aquí 
                    // porque Jenkins ya clonó el código desde fuera del contenedor.
                    sh 'apt-get update && apt-get install -y curl'
                    sh 'curl -LsSf https://astral.sh/uv/install.sh | sh'
                    
                    // Verificamos instalación
                    sh '/root/.local/bin/uv --version'
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                echo 'Sincronizando dependencias con uv...'
                // uv sync busca el archivo pyproject.toml en la raíz
                sh '/root/.local/bin/uv sync'
            }
        }

        stage('Lint & Static Analysis') {
            steps {
                echo 'Ejecutando Linter (Ruff)...'
                // Usamos la ruta absoluta por seguridad
                sh '/root/.local/bin/uv run ruff check .'
            }
        }

        stage('Run Tests') {
            steps {
                echo 'Ejecutando Pruebas (Pytest)...'
                sh '/root/.local/bin/uv run pytest'
            }
        }
    }

    post {
        success {
            echo '¡Pipeline completado con éxito!'
        }
        failure {
            echo 'El pipeline falló. Revisa los pasos anteriores.'
        }
        always {
            echo 'Finalizando ejecución...'
        }
    }
}