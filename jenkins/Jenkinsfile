pipeline {
    agent {
        docker {
            image 'python:3.12-slim'
            args '-u root'
        }
    }

    environment {
        PATH = "/root/.local/bin:${env.PATH}"
        // Mantenemos el hostname coincidente con --name
        DATABASE_URL = "postgresql://user:password@tododbtest:5432/todo_db"
    }

    stages {
        stage('Setup Environment') {
            steps {
                script {
                    echo 'Instalando herramientas necesarias...'
                    sh 'apt-get update && apt-get install -y curl docker.io'
                    sh 'curl -LsSf https://astral.sh/uv/install.sh | sh'
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                sh '/root/.local/bin/uv sync'
            }
        }

        stage('Run Integration Tests') {
            steps {
                script {
                    // 1. Obtenemos el ID de la red del contenedor actual (Python)
                    def network = sh(script: "docker inspect \$(hostname) -f '{{range .NetworkSettings.Networks}}{{.NetworkID}}{{end}}'", returnStdout: true).trim()
                    
                    // 2. Lanzamos Postgres uniéndolo a esa red
                    docker.image('postgres:15-alpine').withRun(
                        "--network ${network} " + 
                        "-e POSTGRES_USER=user " +
                        "-e POSTGRES_PASSWORD=password " +
                        "-e POSTGRES_DB=todo_db " +
                        "--name tododbtest"
                    ) { c ->
                        echo 'Esperando a que Postgres esté listo...'
                        sh 'sleep 15' // Un poco más de tiempo para seguridad
                        
                        echo 'Ejecutando Pytest...'
                        sh 'DATABASE_URL=$DATABASE_URL /root/.local/bin/uv run pytest'
                    }
                }
            }
        }
    }
    
    post {
        always {
            script {
                // Limpieza manual por si el contenedor quedó colgado
                sh 'docker rm -f tododbtest || true'
            }
        }
    }
}