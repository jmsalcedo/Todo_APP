// jenkins/Jenkinsfile
pipeline {
    agent {
        docker {
            image 'python:3.14-slim' // Cambiado a 3.14 para coincidir con tu app
            args '-u root -v /var/run/docker.sock:/var/run/docker.sock'
        }
    }

    environment {
        PATH = "/root/.local/bin:${env.PATH}"
        TEST_NETWORK = "todo-net-${BUILD_NUMBER}"
        DB_HOST = "tododbtest-${BUILD_NUMBER}"
        
        // PUERTOS NO CONVENCIONALES
        DB_PORT = "5433" 
        APP_PORT = "9000"
        
        // URL de conexiÃ³n usando el puerto 5433
        DATABASE_URL = "postgresql://user:password@${DB_HOST}:${env.DB_PORT}/todo_db"
        
        DOCKER_IMAGE = "kaoru751/todo-app-backend"
        DOCKER_TAG = "${BUILD_NUMBER}"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Setup Environment') {
            steps {
                script {
                    echo 'Instalando herramientas y redes...'
                    sh 'apt-get update && apt-get install -y curl docker.io'
                    sh 'curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin'
                    sh 'curl -LsSf https://astral.sh/uv/install.sh | sh'
                    
                    sh "docker network create ${TEST_NETWORK}"
                    def containerId = sh(script: "hostname", returnStdout: true).trim()
                    sh "docker network connect ${TEST_NETWORK} ${containerId}"
                }
            }
        }

        stage('Quality & Static Analysis') {
            steps {
                script {
                    sh '/root/.local/bin/uv sync'
                    sh '/root/.local/bin/uv run ruff check .'
                    sh '/root/.local/bin/uv run bandit -r app/'
                }
            }
        }

        stage('Run Integration Tests') {
            steps {
                script {
                    // Iniciamos Postgres forzando el puerto 5433 mediante PGPORT
                    docker.image('postgres:15-alpine').withRun(
                        "--network ${env.TEST_NETWORK} --name ${env.DB_HOST} " +
                        "-e POSTGRES_USER=user -e POSTGRES_PASSWORD=password -e POSTGRES_DB=todo_db " +
                        "-e PGPORT=${env.DB_PORT}" 
                    ) { c ->
                        echo "Esperando a la base de datos en el puerto ${env.DB_PORT}..."
                        sh 'sleep 20' 
                        sh "DATABASE_URL=${env.DATABASE_URL} /root/.local/bin/uv run pytest"
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                echo "Construyendo imagen preparada para el puerto ${env.APP_PORT}..."
                // Puedes pasar el puerto como build-arg si tu Dockerfile lo soporta
                sh "docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} -t ${DOCKER_IMAGE}:latest ."
            }
        }

        stage('Security Scan (Trivy)') {
            steps {
                sh "trivy image --severity CRITICAL --exit-code 0 ${DOCKER_IMAGE}:${DOCKER_TAG}"
            }
        }

        stage('Push to DockerHub') {
            when {
                expression { 
                    return env.BRANCH_NAME == 'main' || 
                           env.GIT_BRANCH == 'main' || 
                           env.GIT_BRANCH == 'origin/main' || 
                           env.GIT_BRANCH == 'refs/remotes/origin/main'
                }
            }
            steps {
                script {
                    docker.withRegistry('https://index.docker.io/v1/', 'dockerhub-cred') {
                        sh "docker push ${DOCKER_IMAGE}:${DOCKER_TAG}"
                        sh "docker push ${DOCKER_IMAGE}:latest"
                    }
                }
            }
        }
    }

    post {
        always {
            script {
                echo 'Limpiando recursos...'
                sh "docker rm -f ${env.DB_HOST} || true"
                def containerId = sh(script: "hostname", returnStdout: true).trim()
                sh "docker network disconnect ${env.TEST_NETWORK} ${containerId} || true"
                sh "docker network rm ${env.TEST_NETWORK} || true"
            }
        }
    }
}